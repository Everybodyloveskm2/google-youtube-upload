<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../google-signin/google-signin.html">

<!--
Element enabling you to upload videos to YouTube.

##### Examples

Manual upload with an Upload button once videos are selected:

    <google-youtube-upload clientId="..."></google-youtube-upload>

Automatic upload on file select, without Upload button:

    <google-youtube-upload autoUpload clientId="..."></google-youtube-upload>

@element google-youtube-upload
@blurb Element enabling you to upload videos to YouTube.
@status alpha
@homepage http://googlewebcomponents.github.io/google-youtube-upload
-->
<polymer-element name="google-youtube-upload" attributes="autoUpload clientId">
  <template>
    <script src="../cors-upload-sample/upload.js"></script>

    <link rel="stylesheet" href="google-youtube-upload.css"/>

    <google-signin
      clientId="{{clientId}}"
      scopes="https://www.googleapis.com/auth/youtube.upload https://www.googleapis.com/auth/youtube.readonly">
    </google-signin>

    <span style="display:{{ authenticated ? 'inline-block' : 'none' }}">
      <input tabindex="0" type="file" id="files" class="custom-file-input" name="files[]" multiple on-change="{{handleFilePick}}"/>
      <button on-click="{{manualUpload}}" id="upload" style="display:{{ autoUpload ? 'none' : 'block' }}">Upload Videos</button>
    </span>
  </template>

  <script>
    Polymer({
      /**
       * Fired when the upload status changes.
       *
       * @event google-youtube-upload-upload-status
       */

      /**
       * Fired when files have been selected.
       *
       * @event google-youtube-upload-files-selected
       */

      /**
       * Fired when the element attempts to upload files.
       *
       * @event google-youtube-upload-upload-started
       */

      /**
       * Fired when file uploads have successfully completed.
       *
       * @event google-youtube-upload-upload-completed
       */

      /**
       * Fired when file uploads have failed.
       *
       * @event google-youtube-upload-upload-failed
       */

      /**
       * Fired when the upload lists are cleared.
       *
       * @event google-youtube-upload-upload-cleared
       */

      /**
       * A Google Developers clientId reference
       *
       * @attribute clientId
       * @type string
       */
      clientId: '',
      /**
       * The queue of files being uploaded
       *
       * @attribute uploadList
       * @type array
       */
      uploadList: [],
      /**
       * The queue of files that have been uploaded
       *
       * @attribute uploadedList
       * @type array
       */
      uploadedList: [],
      /**
       * Whether files should be automatically uploaded
       *
       * @attribute autoUpload
       * @type boolean
       */
      autoUpload: false,
      /**
       * Whether the user has authenticated or not
       *
       * @attribute authenticated
       * @type boolean
       */
      authenticated: false,
      ready: function () {
        this.fire('google-youtube-upload-upload-status', { status: 'Authentication required' });
        document.addEventListener('google-signin-success', function (e) {
          this.accessToken = e.detail.result.access_token;
          this.authenticated = true;
          this.fire('google-youtube-upload-upload-status', { status: 'Ready' });
        }.bind(this));

        document.addEventListener('google-signed-out', function (e) {
          this.authenticated = false;
          this.fire('google-youtube-upload-upload-status', { status: 'Please sign-in to continue.' });
        }.bind(this));
      },
      selectFiles: function (files) {
        this.queue = files;

        for (var i = 0, f; f = files[i]; i++) {
          this.uploadList.push(f);
        }

        if (this.autoUpload) {
          this.uploadFiles(files);
        }

        this.fire('google-youtube-upload-files-selected', { files: this.uploadList });
        this.fire('google-youtube-upload-upload-status', { status: 'Files selected'});
      },
      manualUpload: function () {
        this.uploadFiles(this.queue);
      },
      uploadFiles: function (files) {
        var uploadedList = this.uploadedList;
        this.fire('google-youtube-upload-upload-started', { files: this.uploadList });
        this.fire('google-youtube-upload-upload-status', { status: 'Uploading' });

        for (var i = 0, f; f = files[i]; i++) {
          var uploader = new MediaUploader({
            file: f,
            token: this.accessToken,
            onError: function (data) {
              this.fire('google-youtube-upload-upload-failed', { data: data })
            },
            onComplete: function (data) {
              uploadedList.push(JSON.parse(data));
              this.fire('google-youtube-upload-upload-status', { status: 'Upload successful' });
              this.uploadList = [];
              this.fire('google-youtube-upload-upload-completed', { files: this.uploadedList, data: data });
            }.bind(this)
          });
          uploader.upload();
        }

      },
      tapSelect: function (evt) {
        this.$.files.click();
      },
      handleFilePick: function (evt) {
        evt.stopPropagation();
        evt.preventDefault();
        this.selectFiles(evt.target.files);
      },
      clearUploadList: function () {
        this.uploadedList = [];
        this.uploadList = [];
        this.fire('google-youtube-upload-upload-cleared', { status: 'Upload lists cleared' });
      }
    });
  </script>
</polymer-element>
