<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../google-signin/google-signin.html">

<!--
Element enabling you to upload videos to YouTube.

##### Examples

Manual upload with an Video Upload button once a video file is selected:

    <google-youtube-upload
      clientId="...">
    </google-youtube-upload>

Automatic upload on video file select, without a Video Upload button:

    <google-youtube-upload
      autoUpload="true"
      clientId="...">
    </google-youtube-upload>

@element google-youtube-upload
@blurb Element enabling you to upload videos to YouTube.
@status alpha
@homepage http://googlewebcomponents.github.io/google-youtube-upload
-->
<polymer-element name="google-youtube-upload" attributes="autoUpload clientId videoTitle description tags categoryId privacyStatus">
  <template>
    <link rel="stylesheet" href="google-youtube-upload.css"/>

    <script src="../cors-upload-sample/upload.js"></script>

    <div id="login-logout">
      <img id="channel-image" src="{{channelThumbnailUrl}}" style="display: {{ channelThumbnailUrl ? 'inline' : 'none' }}">
      <span id="channel-name">{{channelDisplayName}}</span>

      <google-signin
        clientId="{{clientId}}"
        scopes="https://www.googleapis.com/auth/youtube.upload https://www.googleapis.com/auth/youtube.readonly">
      </google-signin>
    </div>

    <div style="display: {{ authenticated ? 'block' : 'none' }}">
      <input type="file" id="file" class="button" accept="video/*" on-change="{{handleFilePick}}">
      <button on-click="{{uploadFile}}" style="display: {{ autoUpload ? 'none' : 'block' }}">Upload Video</button>
      <p id="disclaimer">By uploading a video, you certify that you own all rights to the content or that you are authorized by the owner to make the content publicly available on YouTube, and that it otherwise complies with the YouTube Terms of Service located at <a href="http://www.youtube.com/t/terms">http://www.youtube.com/t/terms</a></p>
    </div>
  </template>

  <script>
    Polymer({
      /**
       * Fired when the upload begins.
       *
       * `e.detail` is set to the
       * [file](https://developer.mozilla.org/en-US/docs/Web/API/File)
       * being uploaded.
       *
       * @event youtube-upload-started
       * @param {Object} e Event parameters.
       */

      /**
       * Fired while the upload is in progress.
       *
       * `e.detail.progressEvent` is set to the corresponding
       * [XMLHttpRequestProgressEvent](http://www.w3.org/TR/progress-events/).
       *
       * `e.detail.estimatedSecondsRemaining` is set to an estimate of the time remaining
       * in the upload, based on the average upload speed so far.
       *
       * `e.detail.bytesPerSecond` is set to the average number of bytes sent per second
       * sent so far.
       *
       * `e.fractionComplete` is set to the fraction of the upload that's complete, in the range [0, 1].
       *
       * @event youtube-upload-progress
       * @param {Object} e Event parameters.
       */

      /**
       * Fired when YouTube upload has failed.
       *
       * Since the actual upload failed, it's not possible for the YouTube server to attempt to
       * process the video, and no `youtube-processing-status` events will be fired.
       *
       * `e.detail` is set to a string explaining what went wrong.
       *
       * @event youtube-upload-failed
       * @param {Object} e Event parameters
       */

      /**
       * Fired when video upload has completed, and YouTube has begun processing the video.
       *
       * At this point, the video is not yet playable, and there is no guarantee that
       * the server-side YouTube processing will succeed.
       *
       * One or more `youtube-processing-status` events will then be fired after this event,
       * followed by either a `youtube-processing-completed` or `youtube-processing-failed`.
       *
       * `e.detail` is set to the YouTube video id of the video.
       *
       * @event youtube-upload-completed
       * @param {Object} e Event parameters.
       */

      /**
       * Fired while server-side processing is in progress.
       *
       * Server-side processing can take an
       * [unpredictable amount of time](https://support.google.com/youtube/answer/71674?hl=en&ref_topic=2888603),
       * and these events will be periodically fired each time the processing status is polled.
       *
       * `e.detail` is set to a
       * [status](https://developers.google.com/youtube/v3/docs/videos#status)
       * object.
       *
       * @event youtube-processing-status
       * @param {Object} e Event parameters
       */

      /**
       * Fired when server-side processing is successful and the video is
       * available for playback on YouTube.
       *
       * The video can be played at `http://youtu.be/VIDEO_ID` or could be
       * embedded using the
       * [`google-youtube`](https://github.com/GoogleWebComponents/google-youtube) element.
       *
       * `e.detail` is set to the YouTube video id of the video.
       *
       * @event youtube-processing-completed
       * @param {Object} e Event parameters
       */

      /**
       * Fired when the video
       * [failed transcoding](https://support.google.com/youtube/topic/2888603?hl=en&ref_topic=16547)
       * and can't be played on YouTube.
       *
       * `e.detail` is set to a
       * [status](https://developers.google.com/youtube/v3/docs/videos#status)
       * object which has more details about the failure.
       *
       * @event youtube-processing-failed
       * @param {Object} e Event parameters
       */

      /**
       * A Google Developers clientId reference.
       *
       * @attribute clientId
       * @type string
       */
      clientId: '',

      /**
       * Whether files should be automatically uploaded.
       *
       * @attribute autoUpload
       * @type boolean
       */
      autoUpload: false,

      /**
       * Whether the user has authenticated or not.
       *
       * @attribute authenticated
       * @type boolean
       */
      authenticated: false,

      /**
       * The title for the new YouTube video.
       *
       * Defaults to 'Untitled Video'.
       *
       * @attribute videoTitle
       * @type string
       * @default 'Untitled Video'
       */
      videoTitle: 'Untitled Video',

      /**
       * The description for the new YouTube video.
       *
       * Defaults to 'Uploaded via https://github.com/GoogleWebComponents/google-youtube-upload'.
       *
       * @attribute description
       * @type string
       * @default 'Uploaded via https://github.com/GoogleWebComponents/google-youtube-upload'
       */
      description: 'Uploaded via https://github.com/GoogleWebComponents/google-youtube-upload',

      /**
       * The array of tags for the new YouTube video.
       *
       * Defaults to ['google-youtube-upload'].
       *
       * @attribute tags
       * @type Array.<string>
       * @default ['google-youtube-upload']
       */
      tags: ['google-youtube-upload'],

      /**
       * The numeric YouTube
       * [cateogry id](https://developers.google.com/apis-explorer/#p/youtube/v3/youtube.videoCategories.list?part=snippet&regionCode=us).
       *
       * Defaults to 22 ("People & Blogs").
       *
       * @attribute categoryId
       * @type number
       * @default 22
       */
      categoryId: 22,

      /**
       * The [privacy setting](https://support.google.com/youtube/answer/157177?hl=en)
       * for the new video.
       *
       * Valid values are 'public', 'private', and 'unlisted'.
       *
       * Defaults to 'public'.
       *
       * @attribute privacyStatus
       * @type string
       * @default 'public'
       */
      privacyStatus: 'public',

      channelDisplayName: 'Not Logged In',
      channelThumbnailUrl: '',
      videoId: '',
      uploadStartTime: 0,
      STATUS_POLLING_ITERVAL_MILLIS: 60 * 1000, // One minute.

      ready: function() {
        document.addEventListener('google-signin-success', function(e) {
          this.accessToken = e.detail.result.access_token;
          this.gapi = e.detail.gapi;
          this.authenticated = true;

          this.gapi.client.request({
            path: '/youtube/v3/channels',
            params: {
              part: 'snippet',
              mine: 'true'
            },
            callback: function(response) {
              if (response.error) {
                this.fire('youtube-upload-failed', response.error.message);
              } else {
                this.channelDisplayName = response.items[0].snippet.title;
                this.channelThumbnailUrl = response.items[0].snippet.thumbnails.default.url;
              }
            }.bind(this)
          });
        }.bind(this));

        document.addEventListener('google-signed-out', function(e) {
          this.authenticated = false;
          this.channelDisplayName = 'Not Logged In';
          this.channelThumbnailUrl = '';
        }.bind(this));
      },

      uploadFile: function() {
        if (this.$.file.files.length > 0) {
          // TODO: Disable "Upload Video" button.
          var f = this.$.file.files[0];

          var metadata = {
            snippet: {
              title: this.videoTitle,
              description: this.description,
              tags: this.tags,
              categoryId: this.categoryId
            },
            status: {
              privacyStatus: this.privacyStatus
            }
          };

          var uploader = new MediaUploader({
            baseUrl: 'https://www.googleapis.com/upload/youtube/v3/videos',
            file: f,
            token: this.accessToken,
            metadata: metadata,
            params: {
              part: Object.keys(metadata).join(',')
            },
            onError: function(data) {
              console.log('onError', data);
              this.fire('youtube-upload-failed', data);
            }.bind(this),
            onProgress: function(data) {
              var currentTime = (new Date).getTime();
              var bytesUploaded = data.loaded;
              var totalBytes = data.total;

              // The times are in millis, so we need to divide by 1000 to get seconds.
              var bytesPerSecond = bytesUploaded / ((currentTime - this.uploadStartTime) / 1000);
              var estimatedSecondsRemaining = (totalBytes - bytesUploaded) / bytesPerSecond;
              var fractionComplete = bytesUploaded / totalBytes;

              this.fire('youtube-upload-progress', {
                progressEvent: data,
                bytesPerSecond: bytesPerSecond,
                estimatedSecondsRemaining: estimatedSecondsRemaining,
                fractionComplete: fractionComplete
              });
            }.bind(this),
            onComplete: function(data) {
              var uploadResponse = JSON.parse(data);
              this.fire('youtube-upload-completed', uploadResponse.id);
              this.videoId = uploadResponse.id;

              this.pollForVideoStatus();
            }.bind(this)
          });

          this.fire('youtube-upload-started', f);
          // This won't correspond to the *exact* start of the upload, but it should be close enough.
          this.uploadStartTime = (new Date).getTime();
          uploader.upload();
        }
        // Else fire an error event? Or just silently ignore?
      },

      handleFilePick: function(e) {
        if (this.autoUpload) {
          this.uploadFile();
        }
      },

      pollForVideoStatus: function() {
        this.gapi.client.request({
          path: '/youtube/v3/videos',
          params: {
            part: 'status',
            id: this.videoId
          },
          callback: function(response) {
            if (response.error) {
              // Not exactly sure how to handle this one, since it means the status polling failed.
              setTimeout(this.pollForVideoStatus.bind(this), this.STATUS_POLLING_ITERVAL_MILLIS);
            } else {
              var status = response.items[0].status;

              switch (status.uploadStatus) {
                // This is a non-final status, so we need to poll again.
                case 'uploaded':
                  this.fire('youtube-processing-status', status);
                  setTimeout(this.pollForVideoStatus.bind(this), this.STATUS_POLLING_ITERVAL_MILLIS);
                break;

                // The video was successfully transcoded and is available.
                case 'processed':
                  this.fire('youtube-processing-completed', this.videoId);
                break;

                // All other statuses indicate a permanent transcoding failure.
                default:
                  this.fire('youtube-processing-failed', status);
                break;
              }
            }
          }.bind(this)
        });
      }
    });
  </script>
</polymer-element>
