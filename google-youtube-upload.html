<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../google-signin/google-signin.html">
<link rel="import" href="../google-youtube/google-youtube.html">

<!--
Element enabling you to upload videos to YouTube.

##### Examples

Manual upload with an Upload button once videos are selected:

    <google-youtube-upload clientId="..."></google-youtube-upload>

Automatic upload on file select, without Upload button:

    <google-youtube-upload autoUpload clientId="..."></google-youtube-upload>

@element google-youtube-upload
@blurb Element enabling you to upload videos to YouTube.
@status alpha
@homepage http://googlewebcomponents.github.io/google-youtube-upload
-->
<polymer-element name="google-youtube-upload" attributes="autoUpload clientId videoTitle description tags categoryId privacyStatus">
  <template>
    <link rel="stylesheet" href="google-youtube-upload.css"/>

    <script src="../cors-upload-sample/upload.js"></script>

    <div>
      <p><img src="{{channelThumbnailUrl}}">{{channelDisplayName}}</p>
      <google-signin
        clientId="{{clientId}}"
        scopes="https://www.googleapis.com/auth/youtube.upload https://www.googleapis.com/auth/youtube.readonly">
      </google-signin>
    </div>

    <div style="display:{{ authenticated ? 'block' : 'none' }}">
      <input tabindex="0" type="file" id="file" accept="video/*" on-change="{{handleFilePick}}">
      <button on-click="{{uploadFile}}" style="display:{{ autoUpload ? 'none' : 'block' }}">Upload Video</button>
    </div>

    <div style="display:{{ fractionComplete ? 'inline-block' : 'none' }}">
      <span>Upload Progress:</span>
      <progress id="progress" max="1" value="{{fractionComplete}}"></progress>
    </div>
  </template>

  <script>
    Polymer({
      /**
       * Fired when there's a change in the progress of the upload.
       *
       * @event google-youtube-upload-progress
       */

      /**
       * Fired when video uploads have successfully completed.
       * The YouTube video id is passed in as a parameter.
       * Note that the video isn't immediately ready for playback;
       * the `google-youtube-upload-video-available` event is fired
       * once the necessary processing is done on YouTube's servers and
       * the video is playable.
       *
       * @event google-youtube-upload-completed
       */

      /**
       * Fired when the video is available for playback on YouTube.
       *
       * @event google-youtube-upload-video-available
       */

      /**
       * Fired when the video failed transcoding and will not playback on YouTube.
       *
       * @event google-youtube-upload-video-failed
       */

      /**
       * Fired when YouTube uploads have failed.
       *
       * @event google-youtube-upload-failed
       */

      /**
       * A Google Developers clientId reference.
       *
       * @attribute clientId
       * @type string
       */
      clientId: '',

      /**
       * Whether files should be automatically uploaded.
       *
       * @attribute autoUpload
       * @type boolean
       */
      autoUpload: false,

      /**
       * Whether the user has authenticated or not.
       *
       * @attribute authenticated
       * @type boolean
       */
      authenticated: false,

      /**
       * The title for the new YouTube video.
       *
       * Defaults to 'Untitled Video'.
       *
       * @attribute videoTitle
       * @type string
       * @default 'Untitled Video'
       */
      videoTitle: 'Untitled Video',

      /**
       * The description for the new YouTube video.
       *
       * Defaults to 'Uploaded via https://github.com/GoogleWebComponents/google-youtube-upload'.
       *
       * @attribute description
       * @type string
       * @default 'Uploaded via https://github.com/GoogleWebComponents/google-youtube-upload'
       */
      description: 'Uploaded via https://github.com/GoogleWebComponents/google-youtube-upload',

      /**
       * The array of tags for the new YouTube video.
       *
       * Defaults to ['google-youtube-upload'].
       *
       * @attribute tags
       * @type Array.<string>
       * @default ['google-youtube-upload']
       */
      tags: ['google-youtube-upload'],

      /**
       * The numeric YouTube cateogry id for the new video. You can retrieve a list of valid
       * category ids via
       * https://developers.google.com/apis-explorer/#p/youtube/v3/youtube.videoCategories.list?part=snippet&regionCode=us
       *
       * Defaults to 22 ("People & Blogs").
       *
       * @attribute categoryId
       * @type number
       * @default 22
       */
      categoryId: 22,

      /**
       * The [privacy setting](https://support.google.com/youtube/answer/157177?hl=en)
       * for the new video.
       *
       * Valid values are 'public', 'private', and 'unlisted'.
       *
       * Defaults to 'public'.
       *
       * @attribute privacyStatus
       * @type string
       * @default 'public'
       */
      privacyStatus: 'public',

      fractionComplete: 0,
      channelDisplayName: 'Not Logged In',
      channelThumbnailUrl: '',
      videoId: '',

      ready: function() {
        this.fire('google-youtube-upload-status', { status: 'Authentication required' });

        document.addEventListener('google-signin-success', function(e) {
          this.accessToken = e.detail.result.access_token;
          this.gapi = e.detail.gapi;
          this.authenticated = true;

          this.gapi.client.request({
            path: '/youtube/v3/channels',
            params: {
              part: 'snippet',
              mine: 'true'
            },
            callback: function(response) {
              if (response.error) {
                // TODO: Make sure we're consistent about which parameters get passed to which events.
                this.fire('google-youtube-upload-failed', { data: response.error });
              } else {
                this.channelDisplayName = response.items[0].snippet.title;
                this.channelThumbnailUrl = response.items[0].snippet.thumbnails.default.url;
              }
            }.bind(this)
          });
        }.bind(this));

        document.addEventListener('google-signed-out', function(e) {
          this.authenticated = false;
        }.bind(this));
      },

      uploadFile: function() {
        if (this.$.file.files.length > 0) {
          // TODO: Disable "Upload Video" button.
          var f = this.$.file.files[0];

          var metadata = {
            snippet: {
              title: this.videoTitle,
              description: this.description,
              tags: this.tags,
              categoryId: this.categoryId
            },
            status: {
              privacyStatus: this.privacyStatus
            }
          };

          var uploader = new MediaUploader({
            baseUrl: 'https://www.googleapis.com/upload/youtube/v3/videos',
            file: f,
            token: this.accessToken,
            metadata: metadata,
            params: {
              part: Object.keys(metadata).join(',')
            },
            onError: function(data) {
              console.log('onError', data);
              this.fire('google-youtube-upload-failed', { data: data });
            }.bind(this),
            onProgress: function(data) {
              this.fractionComplete = data.loaded / data.total;
              this.fire('google-youtube-upload-progress', { data: data });
            }.bind(this),
            onComplete: function(data) {
              var uploadResponse = JSON.parse(data);
              this.fire('google-youtube-upload-completed', { data: uploadResponse });
              this.videoId = uploadResponse.id;
              this.pollForVideoStatus();
            }.bind(this)
          });
          uploader.upload();
        }
        // Else fire an error event? Or just silently ignore?
      },

      handleFilePick: function(e) {
        if (this.autoUpload) {
          this.uploadFile();
        }
      },

      pollForVideoStatus: function() {
        this.gapi.client.request({
          path: '/youtube/v3/videos',
          params: {
            part: 'status',
            id: this.videoId
          },
          callback: function(response) {
            // TODO: Check for response.error
            var status = response.items[0].status;
            switch (status.uploadStatus) {
              // This is a non-final status, so we need to poll again.
              case 'uploaded':
                setTimeout(this.pollForVideoStatus.bind(this), 15 * 1000);
              break;

              // The video was successfully transcoded and is available.
              case 'processed':
                this.fire('google-youtube-upload-video-available', { data: this.videoId });
              break;

              // All other statuses indicate a permanent transcoding failure.
              default:
                this.fire('google-youtube-upload-video-failed', { data: status });
              break;
            }
          }.bind(this)
        });
      }
    });
  </script>
</polymer-element>
